name: Deploy Kops Cluster

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-central-1

    - name: Install Kops
      run: |
        curl -LO https://github.com/kubernetes/kops/releases/download/v1.29.0/kops-linux-amd64
        chmod +x kops-linux-amd64
        sudo mv kops-linux-amd64 /usr/local/bin/kops

    - name: Install kubectl
      run: |
        curl -LO "https://dl.k8s.io/release/v1.29.0/bin/linux/amd64/kubectl"
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/kubectl

    - name: Export env vars
      run: |
        echo "KOPS_STATE_STORE=${{ secrets.KOPS_STATE_STORE }}" >> $GITHUB_ENV
        echo "NAME=${{ secrets.KOPS_CLUSTER_NAME }}" >> $GITHUB_ENV

    - name: Check & create S3 bucket if missing
      id: s3check
      run: |
        BUCKET="${KOPS_STATE_STORE#s3://}"

        echo "Checking if bucket '$BUCKET' exists..."

        if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "Bucket does not exist. Creating..."
          aws s3api create-bucket \
            --bucket "$BUCKET" \
            --region eu-central-1 \
            --create-bucket-configuration LocationConstraint=eu-central-1

          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Check if cluster config exists in S3
      id: configcheck
      run: |
        if aws s3 ls "$KOPS_STATE_STORE/$NAME/config" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Print decision
      run: |
        echo "S3 bucket exists: ${{ steps.s3check.outputs.exists }}"
        echo "Cluster config exists: ${{ steps.configcheck.outputs.exists }}"

    - name: Create cluster (only if config does NOT exist)
      if: steps.configcheck.outputs.exists == 'false'
      run: |
        echo "Creating new cluster..."
        kops create -f kops/cluster.yaml
        kops create -f kops/masters.yaml
        kops create -f kops/nodes.yaml

    - name: Replace cluster config (only if config exists)
      if: steps.configcheck.outputs.exists == 'true'
      run: |
        echo "Cluster exists â€” applying GitOps sync..."
        kops replace -f kops/cluster.yaml --force
        kops replace -f kops/masters.yaml --force
        kops replace -f kops/nodes.yaml --force

    - name: Apply cluster changes
      run: |
        kops update cluster --name $NAME --yes

    - name: Validate cluster
      run: |
        kops validate cluster --name $NAME --wait 10m

    - name: Export kubeconfig for CI
      run: |
        mkdir -p ~/.kube
        kops export kubecfg --name $NAME --admin

    - name: Verify API access
      run: |
        kubectl get nodes

