name: Deploy Kops Cluster

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # 1Ô∏è‚É£ –ó–∞–±–∏—Ä–∞—î–º–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ–π
    - name: Checkout code
      uses: actions/checkout@v4

    # 2Ô∏è‚É£ AWS –¥–æ—Å—Ç—É–ø (–æ–±–æ–≤ º—è–∑–∫–æ–≤–æ –¥–ª—è kOps)
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-central-1

    # 3Ô∏è‚É£ –°—Ç–∞–≤–∏–º–æ kOps
    - name: Install kOps
      run: |
        curl -LO https://github.com/kubernetes/kops/releases/download/v1.29.0/kops-linux-amd64
        chmod +x kops-linux-amd64
        sudo mv kops-linux-amd64 /usr/local/bin/kops

    # 4Ô∏è‚É£ –°—Ç–∞–≤–∏–º–æ kubectl (–¥–ª—è validate + debug)
    - name: Install kubectl
      run: |
        curl -LO https://dl.k8s.io/release/v1.29.0/bin/linux/amd64/kubectl
        chmod +x kubectl
        sudo mv kubectl /usr/local/bin/kubectl

    # 5Ô∏è‚É£ –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ env –¥–ª—è kOps
    - name: Export env vars
      run: |
        echo "KOPS_STATE_STORE=${{ secrets.KOPS_STATE_STORE }}" >> $GITHUB_ENV
        echo "NAME=${{ secrets.KOPS_CLUSTER_NAME }}" >> $GITHUB_ENV

    # 6Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ / —Å—Ç–≤–æ—Ä—é—î–º–æ S3 bucket –¥–ª—è state
    - name: Check & create S3 bucket if missing
      run: |
        BUCKET="${KOPS_STATE_STORE#s3://}"

        echo "Checking if bucket '$BUCKET' exists..."

        if aws s3api head-bucket --bucket "$BUCKET" 2>/dev/null; then
          echo "Bucket exists"
        else
          echo "Bucket does not exist. Creating..."
          aws s3api create-bucket \
            --bucket "$BUCKET" \
            --region eu-central-1 \
            --create-bucket-configuration LocationConstraint=eu-central-1
        fi

    # 7Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –≤–∂–µ —î cluster config —É state
    - name: Check if cluster config exists
      id: configcheck
      run: |
        if aws s3 ls "$KOPS_STATE_STORE/$NAME/config" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
        else
          echo "exists=false" >> $GITHUB_OUTPUT
        fi

    # 8Ô∏è‚É£ –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–±–æ replace –∫–æ–Ω—Ñ—ñ–≥—ñ–≤ (GitOps)
    - name: Create cluster config (first run)
      if: steps.configcheck.outputs.exists == 'false'
      run: |
        echo "Creating new cluster config..."
        kops create -f kops/cluster.yaml
        kops create -f kops/masters.yaml
        kops create -f kops/nodes.yaml

    - name: Replace cluster config (GitOps sync)
      if: steps.configcheck.outputs.exists == 'true'
      run: |
        echo "Cluster config exists ‚Äî syncing..."
        kops replace -f kops/cluster.yaml --force
        kops replace -f kops/masters.yaml --force
        kops replace -f kops/nodes.yaml --force

    # 9Ô∏è‚É£ –†–µ–∞–ª—å–Ω–µ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è / –æ–Ω–æ–≤–ª–µ–Ω–Ω—è AWS —ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∏
    - name: Apply cluster changes
      run: |
        kops update cluster --name $NAME --yes

    # üîü –î–£–ñ–ï –í–ê–ñ–õ–ò–í–û: –¥–∞—î–º–æ control-plane –ø—ñ–¥–Ω—è—Ç–∏—Å—å
    - name: Wait for control plane bootstrap
      run: |
        echo "Waiting for Kubernetes control plane to bootstrap..."
        sleep 120

    # 1Ô∏è‚É£1Ô∏è‚É£ –í–∞–ª—ñ–¥–∞—Ü—ñ—è –∫–ª–∞—Å—Ç–µ—Ä–∞ (nodes + API)
    - name: Validate cluster
      run: |
        kops validate cluster --name $NAME --wait 10m

    # 1Ô∏è‚É£2Ô∏è‚É£ –ï–∫—Å–ø–æ—Ä—Ç—É—î–º–æ kubeconfig (GitOps way)
    - name: Export kubeconfig
      run: |
        mkdir -p ~/.kube
        kops export kubecfg --name $NAME --admin

    # 1Ô∏è‚É£3Ô∏è‚É£ –®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø—É
    - name: Verify cluster access
      run: |
        kubectl get nodes
