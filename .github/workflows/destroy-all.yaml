name: Destroy Kops Cluster and Terraform Infrastructure

on:
  workflow_dispatch:

jobs:
  destroy-all:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v3
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: eu-central-1

    - name: Install Kops
      run: |
        curl -LO https://github.com/kubernetes/kops/releases/download/v1.29.0/kops-linux-amd64
        chmod +x kops-linux-amd64
        sudo mv kops-linux-amd64 /usr/local/bin/kops

    - name: Export cluster name & state store
      run: |
        echo "KOPS_STATE_STORE=${{ secrets.KOPS_STATE_STORE }}" >> $GITHUB_ENV
        echo "NAME=${{ secrets.KOPS_CLUSTER_NAME }}" >> $GITHUB_ENV

    - name: Delete Kops cluster
      run: |
        echo "Deleting Kops cluster: $NAME"
        kops delete cluster --name $NAME --yes

    - name: Wait for AWS to clean up resources
      run: |
        echo "Waiting 180 seconds for AWS EC2, AutoScaling, LaunchTemplates, VPC cleanup..."
        sleep 180

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2

    - name: Terraform Init
      working-directory: terraform
      run: terraform init

    - name: Terraform Destroy
      working-directory: terraform
      run: terraform destroy -auto-approve

    - name: Success Message
      run: echo "ALL INFRASTRUCTURE SUCCESSFULLY DESTROYED âœ”"
